## 一、策略逻辑概述

1. 原版 (wy03)
    *   定位：基准策略，纯粹的满仓轮动，同时也作为其他策略的修改基准。
    *   核心逻辑：基于收盘价对数的线性回归斜率打分，选取得分最高的一只 ETF。
    *   交易与风控：每日 09:30 调仓，无择时与风控。
2. 长短期动量结合版 (long)
    *   定位：改进版，引入反转因子与差异化风控。
    *   核心逻辑：“短期动量 - 长期反转”。结合 25 日动量（追涨）与 200 日反转（防高位接盘）。
    *   交易与风控：
        *   极值过滤：市场极度分化（过热，分差>15）或无主线（过冷，分差<0.1）时空仓。
        *   ETF RSRS 过滤：即便排名第一，若处于顶部风险区则剔除不买。
3. 综合择时版 (yj15)
    *   定位：完整交易系统，引入大盘择时总开关与盘中风控。
    *   核心逻辑：乖离率动量。基于90日乖离率的斜率打分，并引入持仓加分（降低换手）与涨跌幅修正。
    *   交易与风控：
        *   大盘择时 (总开关)：基于沪深300 RSRS 决定整体仓位（满仓/空仓）。
        *   盘中风控：11:25/11:27 两次检查，若跌破阈值（60分钟线跌破MA20）提前止损。
    *   交易执行：09:30 卖出，09:35 买入（分离买卖）。
4. 高收益防御版 (gao)
    *   定位：稳健改良版，引入多重过滤器。
    *   核心逻辑：基础评分逻辑与wy03相似，但使用了加权线性回归 (WLS)，赋予近期数据更高权重。
    *   交易与风控：
        *   交易时间：10:30 (避开早盘波动)。
        *   数据利用：深度利用当日10:30前的实时价格与成交量。
    *   核心特征：
        1.  3日大跌保护：若近3日（含今日实时）任意一日跌幅剧烈，直接剔除。
        2.  成交量异常：若今日开盘一小时成交量相比历史均值异常放量，视为出货信号，直接剔除。
        3.  分数上限：剔除得分过高(>5)的ETF，认为其动量已透支。
5. 动量加速版 (acc)
    *   定位：激进进攻版，追逐“疯牛”。
    *   核心逻辑：在动量评分的基础上，引入“加速度”考核。
    *   交易与风控：
        *   交易时间：09:35 (早盘确认)。
        *   数据利用：基本依赖昨日收盘数据，9:35主要为了确认开盘不跌停/能成交。
    *   核心特征：
        *   动量加速机制：通常策略会回避得分过高的标的（恐高），但本策略反其道而行。若得分极高(>6)，只要满足今日得分 $\ge$ 昨日得分 $\times$ 1.2 (即动量还在加速)，则果断买入。这是一种针对主升浪末端的搏杀逻辑。

## 二、改进方案

**讨论**

1. 是否需要引入长期动量？
2. 上述5个策略的核心是线性回归收益、再结合R^2来判断动量质量，滞后情况如何？能否使用零（低）滞后指标？
3. 如何平衡低延迟和假信号？
4. 输入数值是否用对数（log/ln）处理？

## 三、问题分析与建议 (Analysis & Recommendations)

### 1. 是否需要引入长期动量？
*   **分析**：目前的策略主要集中在短期动量（20-25日）。
    *   `wy03`, `gao`, `acc`, `yj15` 均为短期动量主导。
    *   `long` 策略虽然有名为“long”，但使用的是“短期动量 - 长期反转”（200日反转），即长期看跌。
*   **建议**：
    *   **趋势共振**：可以引入长期动量（如 120日 或 200日 均线/动量）作为**过滤条件**（Filter），而非打分因子。例如：仅在 价格 > 200日均线 时才进行短期动量轮动，有助于规避长期熊市。
    *   **双频轮动**：可以将资金分配为“短期激进”和“长期稳健”两个池子，长期池使用长期动量因子，降低整体换手率和波动。

### 2. 关于线性回归 + R^2 的滞后性与低延迟指标
*   **现状分析**：
    *   `wy03` 使用普通最小二乘法 (OLS)，窗口25天。其“重心”在窗口中间 (t-12.5)，滞后较明显。
    *   `gao` 和 `acc` 使用加权最小二乘法 (WLS)，权重从1线性增加到2。重心向当前时间 t 偏移，滞后减少（约为 t-8 左右），但仍存在。
*   **低/零滞后指标可行性**：
    *   **可用方案**：
        1.  **指数加权移动平均 (EMA) / 分形自适应均线 (FRAMA)**：对近期价格赋予指数级权重，反应更快。
        2.  **Jurik Moving Average (JMA) / Hull Moving Average (HMA)**：这些是专门设计的低滞后均线。
        3.  **Kalman Filter (卡尔曼滤波)**：可以用于估计当前的“真实”价格斜率，对噪声有分离能力，且响应极快。
    *   **替换建议**：可以用 `Jurik Slope` 或 `Kalman Filter Slope` 代替现有的 `Polyfit Slope`。

### 3. 如何平衡低延迟和假信号？
*   **核心矛盾**：低延迟 = 高灵敏度 = 更多噪音（假信号）。高延迟 = 高平滑度 = 错过转折。
*   **解决方案**：
    1.  **多周期共振**：不要单看一个时间窗口。例如，要求 10日动量 和 20日动量 同时由负转正，或者 短周期斜率 > 0 且 长周期斜率 > 0.
    2.  **RCRS (Rank Correlation of Ranks)**：不是看单纯的收益率，而是看排名的稳定性。如果一个ETF连续多日排名上升，信号更可靠。
    3.  **波动率校正**：在计算动量时除以波动率（夏普比率思路）。当市场剧烈波动时，单纯的高收益可能只是噪音；低波动的上涨更可信。目前的 `R^2` 乘子其实已经起到了类似作用（拟合越好，R^2越高，相当于惩罚了高波动）。
    4.  **路径平滑度 (Information Discreteness / ID)**
        *   **原理**：动量的质量取决于它是“连续上涨”还是“跳跃上涨”。ID 指标用来衡量这种区分。
        *   **公式**： $$ ID = sign(Ret) \times \frac{PositiveDays - NegativeDays}{Volatility} $$ 或者简化版（Frog-in-the-pan）： $$ Score = \text{Consistency} = \frac{|Return_{total}|}{\sum |Return_{daily}|} $$
        *   **优势**：比 $R^2$ 更直观地衡量“稳步推升”。那些每天涨0.5%连涨20天的标的，得分会远高于一天涨10%休息19天的标的。

## 四、前沿指标引入：Trendflex 与 Reflex

### 1. 指标背景
由 John Ehlers 在 2020 年提出，旨在解决传统动量指标（如均线、RSI）的滞后性问题。
*   **Reflex**: 零滞后循环指标，用于捕捉短期反转。
*   **Trendflex**: 在 Reflex 基础上改进，保留了趋势分量，适合捕捉趋势。

### 2. 在策略中的应用建议
*   **替换动量因子**：
    *   **Trendflex vs Slope**：`Trendflex` 本质上也是在衡量“当前价格相对于过去价格的偏离程度”，但经过了 SuperSmoother 降噪和 RMS 标准化。
    *   **用法**：可以用 `Trendflex` 的值直接作为评分因子。`Trendflex > 0` 表示上升趋势。由于它归一化了波动率，不同 ETF 之间更具可比性。
*   **辅助过滤 (Reflex)**：
    *   `Reflex` 是一个零滞后的震荡指标，在捕捉**为了反转**（Reversal）或**周期顶点**时非常有效。
    *   当 `Trendflex` 高位（趋势强）但 `Reflex` 此刻开始向下穿越零轴时，可能预示着短期顶部的到来，可以用作**止盈信号**。

## 五、其他建议引入的指标 (Alternatives)

除了 Trendflex 和 Reflex，以下三个指标也非常适合 ETF 轮动策略，特别是在解决滞后性和捕捉趋势方面：

### 1. Ehlers Fisher Transform (费舍尔变换)
*   **逻辑**：将价格数据（通常是非正态分布的）转化为高斯正态分布。这使得极值（超买/超卖）非常清晰，且转折点（Turning Points）极其敏锐。
*   **应用**：
    *   **趋势确认**：Fisher 指标 > 0 且向上发散。
    *   **精准抄底/逃顶**：Fisher 指标到达 +/- 2.0 极端值后的回归。

### 2. MESA Adaptive Moving Average (MAMA & FAMA)
*   **逻辑**：自适应均线。在市场横盘时，它走得很慢（避免假突破）；在趋势爆发时，它紧跟价格（低滞后）。通过 Hilbert Transform 测量相位变化率来调整 Alpha 值。
*   **应用**：非常适合做**止损线**或**趋势过滤器**。当 Price 下穿 MAMA 时，往往是趋势结束的确切信号，比固定周期均线（如 MA20）反应更快且不易被震荡洗出。

### 3. Fractal Adaptive Moving Average (FRAMA)
*   **逻辑**：利用分形维数（Fractal Dimension）来调整均线速度。市场越混沌（震荡），分形维数越高，均线变慢；市场越有趋势，分形维数越低，均线变快。
*   **应用**：替代传统的 MA25 或 MA200。作为长期趋势的判断标准，能有效区分震荡市和趋势市，避免在震荡市中频繁止损。

### 4. 二次拟合 (Quadratic Regression / Polynomial Fit)
*   **逻辑**：不再拟合直线 ($y = ax + b$)，而是拟合抛物线 ($y = ax^2 + bx + c$)。
    *   **一阶项 ($b$)**：代表当前的**速度** (Velocity / Trend)。
    *   **二阶项 ($a$)**：代表**加速度** (Acceleration / Curvature)。
*   **应用**：
    *   **提前预警**：当价格还在上涨但加速度 ($a$) 开始转负（开口向下）时，意味着上涨动能衰竭，是比价格反转更早的**左侧离场信号**。
    *   **加速确认**：当速度和加速度同时为正（开口向上且切线斜率为正）时，代表进入“主升浪”加速段，适合**追涨**。
    *   **代码实现**：使用 `numpy.polyfit(x, y, 2)` 即可。

## 六、指标评估

现有的核心排序逻辑可以概括为：$$ Ranking Score = \text{Trend Magnitude (Slope)} \times \text{Trend Quality (Stability)} $$
即“**涨得有多快**”乘以“**涨得有多稳**”（$Slope \times R^2$）。以下将所有讨论的指标按这两个维度进行分类评估。

### 1. 趋势强度 (Trend Magnitude / Slope) - 用于衡量“涨速”

此维度衡量价格上涨的速率或爆发力。

| 指标 | 类型 | 滞后性 | 评价与适配性 |
| :--- | :--- | :--- | :--- |
| **OLS Slope** | 线性回归 | 高 | (基准) 稳定但反应慢，容易在趋势末端高位接盘。 |
| **WLS Slope** | 加权回归 | 中 | (改进) 给予近期价格更高权重，通过 `gao/acc` 验证有效，是目前的主力。 |
| **Trendflex** | 滤波器 | 低 | **极佳**。专门设计用于衡量“剔除噪声后的趋势分量”。其绝对值可直接替代 Slope。反应比 WLS 更快且自带平滑。 |
| **Fisher Transform** | 非线性变换 | 极低 | **激进**。将价格概率密度正态化，对价格变化极其敏感。适合捕捉“加速段”，但容易有过拟合风险 (Overshoot)。 |
| **2nd Order Fit (Acceleration)** | 二次拟合 | 中 | **高阶信息**。提供“加速度”维度。单纯替代 Slope 效果一般，但作为**附加因子** (Bonus Factor) 非常强。 |
| **MAMA/FAMA Gap** | 均线乖离 | 自适应 | **良**。利用 $(Price - MAMA)$ 或 $(MAMA - FAMA)$ 的差值。在趋势启动时反应快，震荡时反应慢（优点）。 |
| **Reflex** | 震荡指标 | 零 | **不适用**。这是反转指标，用于判断顶部/底部，不适合衡量趋势强度。 |

### 2. 趋势质量 (Trend Quality / Stability) - 用于衡量“稳定性”

此维度衡量趋势的平滑度、线性度或信噪比，用于剔除高波动、跳跃式上涨的标的。

| 指标 | 原理 | 评价与适配性 |
| :--- | :--- | :--- |
| **$R^2$ (拟合优度)** | 线性度 | (基准) 衡量价格曲线与直线的拟合程度。数值越大越稳。缺点是计算窗口固定，对突变反应慢。 |
| **Fractal Dimension (D)** | 分形维数 | **极佳 (FRAMA副产物)**。$D \in [1, 2]$。$1.0$ 代表完美直线，$2.0$ 代表随机噪声。**使用 $2-D$ 替代 $R^2$**，能更敏锐地捕捉从震荡转为趋势的瞬间。 |
| **Efficiency Ratio (ER)** | 效率系数 | **良 (KAMA副产物)**。$\text{Net Change} / \sum \text{Abs Change}$。即“位移/路程”。逻辑简单有效，计算极快。 |
| **Trendflex (内置)** | 信噪比 | **良**。Trendflex 计算公式中分母包含了 RMS (噪声幅值)，因此它输出的数值已经是“单位噪声下的趋势强度”。理论上不需要额外乘 $R^2$，或者权重可以降低。 |

### 3. 组合建议 (New Ranking Formulas)

根据上述拆解，推荐以下几种新组合来升级原始的 `Slope * R^2`：

#### A. 均衡型 (推荐)
$$ Score = \text{Trendflex} \times (2 - \text{Fractal Dimension}) $$
*   **逻辑**：用 Ehlers 的Trendflex衡量趋势（代替Slope），用分形维数衡量稳定性（代替$R^2$）。即“涨得快 且 走势接近直线”。

#### B. 极速型 (激进)
$$ Score = \text{Fisher Transform} $$
*   **逻辑**：Fisher 变换自带归一化（Sigma），直接寻找短期爆发力最强的品种。
*   **注意**：需配合严格止损（如 Reflex 顶背离时卖出），防止高位被挂。

#### C. 稳健型 (低回撤)
$$ Score = \text{WLS Slope} \times \text{Efficiency Ratio (ER)} $$
*   **逻辑**：用加权回归捕捉趋势，用卡夫曼效率系数(ER)剔除高波动品种。ER比$R^2$反应更直接。

#### D. 原版改良 (最小改动)
$$ Score = \text{WLS Slope} \times (2 - \text{Fractal Dimension}) $$
*   **逻辑**：保留 `gao` 策略的加权回归逻辑，但用更敏感的分形维数 $D$ 替代 $R^2$。

### 4. 总结与实施路线

经过几十轮测试，汇总结果如下，先说明测试条件：
1. 使用`gao`策略
2. 测试时间为2023/01/01-2026/02/08
3. 交易标的为原代码中的固定ETF，仅修改了评分计算方法，并调试了相应的参数

发现如下情况：
1. 总体来说，依旧是原版 `WLS*R2` 表现最好，其适应参数的范围相对较宽，例如`M_DAYS=22-27`、`MAX_SCORE=5-9`的表现都不错
2. 略差一等的是 `WLS*ER` 和 `WLS*(2-D)`，表现和原版接近（不如原版），参数范围也与原版相似
3. `Trendflex` 和 `Fisher Transform` 表现较差，且对参数适应能力较差，波动较大