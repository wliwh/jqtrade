# 聚类算法在金融数据中的特性分析与建议

基于对 `Pools/ap_pools_documentation.md` 和 `Pools/join_method.py` 的深入阅读，以下是对四种聚类方法（AP, Hierarchical, MST, DBSCAN）的分析、比较及应用建议。

## 1. 四种聚类方法的比较

我们将从**算法原理**、**参数敏感性**、**对金融数据的适应性**以及**在代码中的具体实现特性**四个维度进行比较。

| 特性维度 | AP 聚类 (Affinity Propagation) | 层次聚类 (Hierarchical) | 最小生成树 (MST) | DBSCAN (密度聚类) |
| :--- | :--- | :--- | :--- | :--- |
| **核心逻辑** | **寻找代表点**。通过节点间“消息传递”找出最具代表性的 Exemplars。 | **层级构建**。自下而上合并相似资产，通过“切割”树状图获得分类。 | **骨架结构**。构建关联网络，保留最强连接，切断 $K-1$ 条最弱边。 | **密度与噪声**。基于密度连通性聚类，稀疏区域点被视为“噪声”。 |
| **簇数量确定** | **自动**。由数据本身决定（受 `damping` 影响）。 | **半自动**。通过设定相关性阈值 (`cluster_corr_threshold`) 决定。 | **手动**。需预先指定目标簇数量 `mst_n_clusters`。 | **自动**。由 `eps` 和 `min_samples` 决定。 |
| **对异常值处理** | 倾向于将异常值归入最近的 Exemplar，或自成一类（视其独特性）。 | 异常值往往在树的顶层才被合并，或者在切割时自成一类。 | 异常值可能成为“孤岛”或通过弱连接挂在某簇边缘。 | **极佳**。显式标记为 **Noise (-1)**，代码中逻辑为**保留所有 Noise**。 |
| **计算复杂度** | 较高（$O(N^2)$），但本代码预先进行了流动性筛选，问题不大。 | 中等（$O(N^2)$），生成树状图。 | 中等（需构建完全图和MST），但在稀疏图中较快。 | 较低（$O(N^2)$），但在高维数据下距离计算耗时。 |
| **代码实现亮点** | 自动选出每个簇中流动性最好的作为代表。 | 使用 Average Linkage 方法，结果较稳定；阈值直观（相关性）。 | 计算 NTL (Normalized Tree Length) 可兼顾监控市场系统性风险。 | **将 Noise 视为独立资产全部保留**，极大地增强了池子的非相关性。 |

## 2. 深入特性分析

### 2.1 Affinity Propagation (AP)
*   **特性**：最“民主”的方法。它不是强制划分，而是通过不断协商找到大家都认可的中心。
*   **适用场景**：市场风格由于宏观原因频繁切换，且风格数量不固定的时期。它能自适应地捕捉当前市场有几个“热点”。
*   **局限**：对 `damping` (阻尼系数) 敏感，收敛可能较慢（虽然这里 ETF 数量不多，影响有限）。

### 2.2 Hierarchical Clustering (层次)
*   **特性**：最符合人类认知的分类方式。可以画出谱系图（Dendrogram），清晰看到板块是如何一步步聚合的（如：白酒 -> 消费 -> 大盘股）。
*   **适用场景**：需要通过直观阈值（如“我只想要相关性 0.8 以上的聚集在一起”）来控制精细度时。
*   **局限**：贪婪算法，一旦合并无法撤销。

### 2.3 Minimum Spanning Tree (MST)
*   **特性**：Econophysics（经济物理学）的经典方法。它关注的是市场的**拓扑结构**。
*   **适用场景**：主要用于**宏观监测**市场脆弱性（NTL指标）。作为选股工具时，由于需要硬性指定簇数量，灵活性稍逊，但能确保选出的是互斥性最强的几个板块核心。
*   **局限**：必须预判“市场分为几类”。

### 2.4 DBSCAN (重点推荐)
*   **特性**：**“寻找异类”**。这是唯一一个明确定义“噪声”的算法。在金融市场中，“噪声”往往意味着**Alpha**——那些不随大流、有独立逻辑的资产。
*   **代码特异性**：`join_method.py` 中的实现特别指出 `Retaining unique outliers (Noise)`。这意味着它生成的池子包含：
    1.  主流板块的龙头（每个簇选一个流动性最好的）。
    2.  所有特立独行的资产（噪声）。
*   **优势**：极大地丰富了策略的多样性，不仅抓住了主流风格，还涵盖了潜在的独立行情资产。

## 3. 建议与总结

**推荐排序：DBSCAN > AP > Hierarchical > MST**

### 综合建议：

1.  **首选 DBSCAN**：
    *   **理由**：ETF轮动的核心痛点是“同涨同跌”。DBSCAN 通过保留 Noise（噪声点），天然地引入了低相关性资产。传统的聚类（如 K-Means 或 MST）会强制把所有资产归类，导致某些独特的资产被淹没在大的板块中。此时，DBSCAN 的“保留异类”策略在分散风险和捕捉独立行情上具有巨大优势。
    *   **参数建议**：重点调节 `eps`。`eps` 过小会导致全是噪声（池子太大且杂），`eps` 过大会导致聚成一团（失去筛选意义）。建议从 `0.3-0.5` 左右开始尝试。

2.  **次选 AP 聚类**：
    *   **理由**：无需指定簇数量，自适应性强。如果市场结构稳定，AP 能找出非常好的代表性资产（Exemplars）。它是次优的平衡选择。

3.  **如果需要通过相关性阈值控制**：使用 **Hierarchical**。
    *   **理由**：它的物理意义最清晰。设定 `0.7` 或 `0.8` 的相关性阈值，可以精准控制池内资产的互斥程度。

4.  **对于 MST**：
    *   **建议**：更多地将其作为**市场状态监控工具**（观察 NTL 变化），而不是直接用于构建轮动池，除非你对“我们要选 N 个资产”有非常强烈的硬性约束。

### 总结
文档中提到的核心目标是**“低冗余”**和**“高代表性”**。
*   **AP** 在“高代表性”上做得最好（寻找 Exemplars）。
*   **DBSCAN** 在“低冗余”和发现“独特声音”上做得最好（保留 Outliers）。

鉴于轮动策略通常追求捕捉轮动的 Alpha，**建议优先尝试 DBSCAN 模式**，因为它更有可能囊括那些正在走出独立行情的“黑马”。
