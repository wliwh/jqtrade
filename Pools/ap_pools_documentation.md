# 寻找市场的脊梁——基于聚类算法的ETF轮动池构建研究

## 研究背景

论坛上已经由很多ETF轮动策略，但是如何确定轮动所在的ETF池子尚待研究。

现有的动量轮动策略，往往将重点放在“选哪只”上面，而忽略了“从哪里选”这个问题。大多数策略使用的ETF池子，要么是有后视镜嫌疑的4只ETF，要么是基于主观经验加入特定行业ETF。

这两种方式都存在明显的局限性，难免带有幸存者偏差，且难以适应市场风格的长期演变。因此，本研究试图探讨一个核心问题：能否通过数学方法，客观地筛选出一个既能覆盖市场主流风格，又彼此低相关的精英ETF池？

## 研究思路

本研究提出了一种基于聚类算法的ETF池构建框架。我们的核心观点是，一个优秀的轮动池应当具备两个特征：低冗余和高代表性。

为此，我们设计了包含三个步骤的筛选流程：

### 1. 基础过滤：提升数据质量

在进行复杂的数学计算之前，首先需要清洗数据。我们设定了一系列硬性指标，剔除那些不具备研究价值的标的。我们将成交额过低、上市时间过短以及非核心资产（如部分边缘的债券或含有特定风险的品种）排除在外。这一步是为了确保后续选出的标的都具有良好的流动性和可交易性。

### 2. 聚类分析：发现市场结构

这是本研究的核心环节。我们引入了无监督学习中的聚类算法，利用ETF之间的历史价格相关性矩阵，自动识别市场的板块结构。

我们分别测试了四种方法，它们各有侧重。基于对这四种方法的特性分析，我们建议的**优先级排序为：DBSCAN > AP > Hierarchical > MST**。

*   **DBSCAN (密度聚类)**：
    *   **核心特性**：唯一能明确识别“噪声”的算法。算法将紧密相连的高密度区域划分为簇，而处于低密度区域的点会被标记为“噪声”。
    *   **优势**：在金融市场中，“噪声”往往意味着**独特的Alpha**——即那些不随大流、有独立逻辑的“独行侠”资产。代码实现中我们特意保留了所有噪声点，这极大地丰富了策略的多样性，既抓住了主流板块龙头，又不仅漏掉独立行情资产，最符合“低冗余、高代表性”的目标。
    *   **参数建议**：重点调节 `eps` (约0.3-0.5)，以平衡簇的纯度和噪声的数量。
*   **Affinity Propagation (AP聚类)**：
    *   **核心特性**：最“民主”的方法。通过节点间消息传递自动找出最具代表性的中心点。
    *   **优势**：无需指定簇数量，自适应性强。如果市场结构稳定，AP能找出非常好的代表性资产。适合在市场风格变化快且风格数量不固定的时期使用。
    *   **与K-Means对比**：AP聚类可视为 K-Means 的进化版，更适合金融场景。它直接选取**真实资产**作为中心，避免了 K-Means 产生的“虚拟质心”无法交易的问题；且无需预设 K 值，能自适应市场结构。
    *   **参数建议**：主要调节 `damping` (阻尼系数，0.5-0.9)，数值越高收敛越稳，但迭代越慢。
*   **Hierarchical Clustering (层次聚类)**：
    *   **核心特性**：类似于生物分类学，自下而上构建谱系树。
    *   **优势**：物理意义最清晰。通过设定明确的相关性阈值（如0.85），可以像切蛋糕一样精准控制池内资产的互斥程度。适合对相关性有硬性控制要求的场景。
    *   **参数建议**：核心参数为 `cluster_corr_threshold` (相关性阈值)。建议设为 0.6~0.85，值越高，对低相关性的容忍度越低，划分出的簇越多。
*   **Minimum Spanning Tree (MST, 最小生成树)**：
    *   **核心特性**：基于图论，保留连接所有节点的最强连线骨架。
    *   **建议**：比起构建轮动池，MST更适合作为**市场风险监控工具**（利用树长 NTL 指标）。作为选股工具需要预判簇数量，灵活性稍逊。
    *   **参数建议**：需指定 `mst_n_clusters` (目标簇数量)，一般建议根据市场大类数量的经验设置。

与传统的行业分类不同，聚类算法完全基于数据的真实波动。如果消费和医疗在某段时间走势高度一致，算法就会敏锐地将它们归为一类。

通过聚类，我们将高相关性的ETF归并为一个个簇。在每个簇中，我们只保留流动性最好的一只作为代表。这样做的目的，是强行切断资产间的高相关性，确保最终的池子里的每一只ETF，都代表了市场的一种独特声音。

### 3. 多轮聚合

新增 `multi_round_aggregation` 函数，支持按月/周回溯历史多个时间点的聚类结果。这有助于观察池子的稳定性，以及为回测提供历史上不同时间点的动态池子名单。

### 4. 动量验证：检验池子效率

为了验证构建出的ETF池是否具有投资价值，我们引入了一个简单的动量评分机制。我们观察在同等动量策略下，基于聚类构建的池子是否能比简单的全市场池捕捉到更清晰的趋势。

## 研究结论展望

通过代码实现与初步回测，我们发现基于聚类构建的ETF池在降低波动率和提升夏普比率方面展现出了潜力。这表明，在动量轮动之前进行一步科学的“池子瘦身”，是提升策略稳健性的有效手段。本代码即为该研究思路的具体实现。

## 代码实现说明

为了提高代码的可维护性和易用性，我们对项目进行了以下更新：

1.  **模块化设计**：核心的聚类算法逻辑已移至 `Pools/join_method.py`，保持主程序的整洁。
2.  **新参数支持**：
    *   `verbose`：控制输出详细程度。在多轮测试时设为 `False` 可保持界面清爽。
    *   `clustering_method`：支持 `"ap"`, `"hierarchical"`, `"mst"`, `"dbscan"` 四种模式。
    *   `black_list`：支持自定义黑名单剔除。
3.  **结果美化**：引入 `pretty_print` 函数，使输出的表格更加整齐易读。



## ETF聚类结果分析 (2025-2026)

基于对最近12期（2025/02-2026/01）聚类结果的追踪分析，我们发现市场呈现出**“核心稳定，边缘进化”**的特征：

### 1. 稳定性分析
*   **存活率**：70-80%。这就意味着每个月约有20-30%标的的分类会发生显著变化，体现了市场风格轮动的活跃性。
*   **核心资产**：尽管轮动剧烈，但仍有约21个“核心家族”在整个周期内始终存在，构成了市场的稳定基石。

### 2. 主流代表性ETF
在全年的演化中，出现频率最高的代表性ETF（即各簇的领头羊）包括：
1.  **300ETF**（全市场核心）
4.  **500ETF**（中盘成长）
6.  **创业板**（成长风格）
5.  **红利ETF、香港红利ETF**（价值风格）
7.  **人工智能**（产业主题）
8.  **中概互联**
9.  **芯片**
10. **军工**
8.  **消费**（消费风格）
9.  **医疗**（防御/消费）
10. **香港创新药**（防御/消费）
11. **银行**
10. **证券**（牛市旗手）
11. **黄金**（避险资产）
2.  **纳指ETF**（跨境科技锚点）
3. 
3. **德国**、**沙特**
3.  **标普油气**（跨境能源）
4. **豆粕**

### 3. 几点发现

1. 沪深300、中证A500在过去一年中始终代表着国内核心资产，在2025年夏季，两者走势出现一定差异
2. 中证500，这一组中还有中证1000、国证2000等ETF，这说明过去一年中小盘走势高度一致。而且中证500这一组中不少ETF经常流动，包括流入`机器人`簇、`金融科技`簇等，这说明。。。
3. 创业板，偶尔和光伏组、人工智能组发生流动
4. 科创板，科创50在10月分离出半导体设备；而6月份`中证500`组分离出科创100
5. 红利份为三组：中证红利、红利低波、香港红利；红利低波由早期的银行组演化而来
6. 。。。

### 3. 几点发现（数据实证）


1.  **核心资产的演变**：
    *   沪深300与中证A500同属一个强相关簇。但在 **2025年6-7月** 和 **2026年1月**，簇发生了分裂，A500基金从300ETF簇中分离出来。

2.  **中小盘的高度同质化**：
    *   **中证500**簇实际上是一个泛中小盘集合。数据详细页显示，**中证1000**（如512100）和**国证2000**（如563300）长期被归类在以中证500为核心的簇中。这说明过去一年，A股的Size因子（市值下沉）效应高度统一，单纯的市值下沉（500->1000->2000）很难提供独立的差异化走势。
    *   **“蓄水池”效应**：中证500这一组中不少ETF经常流入它组，包括流入`机器人`簇、`金融科技`簇等。这说明**中证500充当了成长股的“公共蓄水池”**。当特定科技赛道（如机器人）行情火热产生强贝塔时，500中相关的成长成分股会被“吸”走，归入主题簇；而当主题退潮时，这些资产又回归平庸，重新融入中证500的宽基波动中。

3.  **科技风格的裂变**：
    *   **创业板**：偶尔和光伏组、人工智能组发生流动。
    *   **科创50的提纯**：2025年10月，**半导体设备**从**科创50**中独立分化出来，显示市场对硬科技的交易颗粒度变细。
    *   **科创100的独立**：2025年7月，**科创100**脱离了**中证500/中小盘**的引力场，形成独立簇，这意味着科创板的小盘股走出了独立于主要板指的小票行情。

4.  **红利策略的“三位一体”演化**：
    *   市场清晰地保留了三条红利主线：**中证红利**、**红利低波**和**香港红利**。
    *   最有意思的是Family 28：在2025年6月之前，该簇的代表是**银行ETF**，之后变为**红利低波**。这提供了强有力的证据：银行板块在去年年中完成了属性切换，被市场彻底当成低波红利资产进行交易。

5.  **跨境资产的“真假隔离”**：
    *   **纳指ETF**是全市场唯一在12个月中从未与任何A股资产发生合并或高相关的“孤岛”，证明了其作为资产配置中（真正的）分散化工具的价值。
    *   反观**中概互联/港股通互联网**，虽然也是跨境，但结构上经常与A股科技成长板块产生联动，其分散化效果弱于美股。

## 代码中的问题

`Pools/join_method.py` 中的 `get_ranking_data` 函数，现在是无法处理总市值的，使用的`get_fundamentals`函数只能得到股票而非ETF的总市值数据。

采用这样的API可以获取到ETF的总份额数据：

```python
p = get_price(['563360.XSHG'], end_date='2026-01-31', count=5, frequency='daily', fields=['close'], panel=False)
finance.run_query(query(finance.FUND_SHARE_DAILY).filter(
    finance.FUND_SHARE_DAILY.date.in_(p.time.tolist()),
    finance.FUND_SHARE_DAILY.code.in_(['563360.XSHG'])))
    # .order_by(-finance.FUND_SHARE_DAILY.date).limit(5)
    # order_by 用于排序，limit 用于限制返回的行数
# > 返回值为pd.DataFrame，包含ETF的总份额数据。
#   id	    code	    name	exchange_code	date	shares
# 0	2925861	563360.XSHG	A500基金	XSHG	2026-01-26	34945987400
# 1	2927763	563360.XSHG	A500基金	XSHG	2026-01-27	34783987400
# 2	2929935	563360.XSHG	A500基金	XSHG	2026-01-28	35026987400
# 3	2931599	563360.XSHG	A500基金	XSHG	2026-01-29	34978987400
# 4	2933516	563360.XSHG	A500基金	XSHG	2026-01-30	36061987400
```
