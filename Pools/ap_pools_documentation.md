# 寻找市场的脊梁——基于聚类算法的ETF轮动池构建研究

## 研究背景

论坛上已经由很多ETF轮动策略，但是如何确定轮动所在的ETF池子尚待研究。

现有的动量轮动策略，往往将重点放在“选哪只”上面，而忽略了“从哪里选”这个问题。大多数策略使用的ETF池子，要么是有后视镜嫌疑的4只ETF，要么是基于主观经验加入特定行业ETF。

这两种方式都存在明显的局限性，难免带有幸存者偏差，且难以适应市场风格的长期演变。因此，本研究试图探讨一个核心问题：能否通过数学方法，客观地筛选出一个既能覆盖市场主流风格，又彼此低相关的精英ETF池？

## 研究思路

本研究提出了一种基于聚类算法的ETF池构建框架。我们的核心观点是，一个优秀的轮动池应当具备两个特征：低冗余和高代表性。

为此，我们设计了包含三个步骤的筛选流程：

### 1. 基础过滤：提升数据质量

在进行复杂的数学计算之前，首先需要清洗数据。我们设定了一系列硬性指标，剔除那些不具备研究价值的标的。我们将成交额过低、上市时间过短以及非核心资产（如部分边缘的债券或含有特定风险的品种）排除在外。这一步是为了确保后续选出的标的都具有良好的流动性和可交易性。

### 2. 聚类分析：发现市场结构

这是本研究的核心环节。我们引入了无监督学习中的聚类算法，利用ETF之间的历史价格相关性矩阵，自动识别市场的板块结构。

我们分别测试了四种方法，它们各有侧重。基于对这四种方法的特性分析，我们建议的**优先级排序为：DBSCAN > AP > Hierarchical > MST**。

*   **DBSCAN (密度聚类)**：
    *   **核心特性**：唯一能明确识别“噪声”的算法。算法将紧密相连的高密度区域划分为簇，而处于低密度区域的点会被标记为“噪声”。
    *   **优势**：在金融市场中，“噪声”往往意味着**独特的Alpha**——即那些不随大流、有独立逻辑的“独行侠”资产。代码实现中我们特意保留了所有噪声点，这极大地丰富了策略的多样性，既抓住了主流板块龙头，又不仅漏掉独立行情资产，最符合“低冗余、高代表性”的目标。
    *   **参数建议**：重点调节 `eps` (约0.3-0.5)，以平衡簇的纯度和噪声的数量。
*   **Affinity Propagation (AP聚类)**：
    *   **核心特性**：最“民主”的方法。通过节点间消息传递自动找出最具代表性的中心点。
    *   **优势**：无需指定簇数量，自适应性强。如果市场结构稳定，AP能找出非常好的代表性资产。适合在市场风格变化快且风格数量不固定的时期使用。
    *   **与K-Means对比**：AP聚类可视为 K-Means 的进化版，更适合金融场景。它直接选取**真实资产**作为中心，避免了 K-Means 产生的“虚拟质心”无法交易的问题；且无需预设 K 值，能自适应市场结构。
    *   **参数建议**：主要调节 `damping` (阻尼系数，0.5-0.9)，数值越高收敛越稳，但迭代越慢。
*   **Hierarchical Clustering (层次聚类)**：
    *   **核心特性**：类似于生物分类学，自下而上构建谱系树。
    *   **优势**：物理意义最清晰。通过设定明确的相关性阈值（如0.85），可以像切蛋糕一样精准控制池内资产的互斥程度。适合对相关性有硬性控制要求的场景。
    *   **参数建议**：核心参数为 `cluster_corr_threshold` (相关性阈值)。建议设为 0.6~0.85，值越高，对低相关性的容忍度越低，划分出的簇越多。
*   **Minimum Spanning Tree (MST, 最小生成树)**：
    *   **核心特性**：基于图论，保留连接所有节点的最强连线骨架。
    *   **建议**：比起构建轮动池，MST更适合作为**市场风险监控工具**（利用树长 NTL 指标）。作为选股工具需要预判簇数量，灵活性稍逊。
    *   **参数建议**：需指定 `mst_n_clusters` (目标簇数量)，一般建议根据市场大类数量的经验设置。

与传统的行业分类不同，聚类算法完全基于数据的真实波动。如果消费和医疗在某段时间走势高度一致，算法就会敏锐地将它们归为一类。

通过聚类，我们将高相关性的ETF归并为一个个簇。在每个簇中，我们只保留流动性最好的一只作为代表。这样做的目的，是强行切断资产间的高相关性，确保最终的池子里的每一只ETF，都代表了市场的一种独特声音。

### 3. 多轮聚合

新增 `multi_round_aggregation` 函数，支持按月/周回溯历史多个时间点的聚类结果。这有助于观察池子的稳定性，以及为回测提供历史上不同时间点的动态池子名单。

### 4. 动量验证：检验池子效率

为了验证构建出的ETF池是否具有投资价值，我们引入了一个简单的动量评分机制。我们观察在同等动量策略下，基于聚类构建的池子是否能比简单的全市场池捕捉到更清晰的趋势。

## 研究结论展望

通过代码实现与初步回测，我们发现基于聚类构建的ETF池在降低波动率和提升夏普比率方面展现出了潜力。这表明，在动量轮动之前进行一步科学的“池子瘦身”，是提升策略稳健性的有效手段。本代码即为该研究思路的具体实现。

## 代码实现说明

为了提高代码的可维护性和易用性，我们对项目进行了以下更新：

1.  **模块化设计**：核心的聚类算法逻辑已移至 `Pools/join_method.py`，保持主程序的整洁。
2.  **新参数支持**：
    *   `verbose`：控制输出详细程度。在多轮测试时设为 `False` 可保持界面清爽。
    *   `clustering_method`：支持 `"ap"`, `"hierarchical"`, `"mst"`, `"dbscan"` 四种模式。
    *   `black_list`：支持自定义黑名单剔除。
3.  **结果美化**：引入 `pretty_print` 函数，使输出的表格更加整齐易读。